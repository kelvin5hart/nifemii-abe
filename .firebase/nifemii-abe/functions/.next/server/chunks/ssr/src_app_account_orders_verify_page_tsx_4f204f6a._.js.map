{"version":3,"sources":["../../../../src/app/account/orders/verify/page.tsx"],"sourcesContent":["\"use client\";\n\nimport { useEffect, useState, Suspense } from \"react\";\nimport { useSearchParams, useRouter } from \"next/navigation\";\nimport Link from \"next/link\";\nimport { doc, updateDoc, getDoc, Timestamp } from \"firebase/firestore\";\nimport { db } from \"@/lib/firebase\";\n\nfunction VerifyPaymentContent() {\n  const searchParams = useSearchParams();\n  const router = useRouter();\n  const [status, setStatus] = useState<\"loading\" | \"success\" | \"failed\">(\"loading\");\n  const [error, setError] = useState(\"\");\n\n  const reference = searchParams.get(\"reference\");\n  const trxref = searchParams.get(\"trxref\");\n  const paymentRef = reference || trxref;\n\n  useEffect(() => {\n    const verifyPayment = async () => {\n      if (!paymentRef) {\n        setStatus(\"failed\");\n        setError(\"No payment reference found\");\n        return;\n      }\n\n      try {\n        // Verify payment with our API\n        const response = await fetch(`/api/paystack/verify?reference=${paymentRef}`);\n        const data = await response.json();\n\n        if (!response.ok) {\n          throw new Error(data.error || \"Verification failed\");\n        }\n\n        if (data.status === \"success\") {\n          const orderId = data.metadata?.orderId;\n          const paymentType = data.metadata?.paymentType || \"full\";\n          const amountPaid = data.amount / 100; // Convert from kobo to Naira\n\n          if (orderId) {\n            try {\n              // Get current order to update correctly\n              const orderDoc = await getDoc(doc(db, \"orders\", orderId));\n\n              if (orderDoc.exists()) {\n                const orderData = orderDoc.data();\n                const updateData: Record<string, unknown> = {\n                  updatedAt: Timestamp.now(),\n                };\n\n                if (paymentType === \"deposit\") {\n                  // Mark deposit as paid\n                  updateData[\"pricing.depositPaid\"] = true;\n                  updateData[\"pricing.depositMethod\"] = \"paystack\";\n                  updateData[\"pricing.depositDate\"] = Timestamp.now();\n                  updateData[\"pricing.depositPaymentRef\"] = paymentRef;\n                  // Confirm order when deposit is paid\n                  if (orderData.status === \"pending\") {\n                    updateData.status = \"confirmed\";\n                  }\n                } else if (paymentType === \"balance\") {\n                  // Mark balance as paid\n                  updateData[\"pricing.balancePaid\"] = true;\n                  updateData[\"pricing.balanceMethod\"] = \"paystack\";\n                  updateData[\"pricing.balanceDate\"] = Timestamp.now();\n                  updateData[\"pricing.balancePaymentRef\"] = paymentRef;\n                } else {\n                  // Full payment - mark both deposit and balance as paid\n                  updateData[\"pricing.depositPaid\"] = true;\n                  updateData[\"pricing.depositAmount\"] = amountPaid;\n                  updateData[\"pricing.depositMethod\"] = \"paystack\";\n                  updateData[\"pricing.depositDate\"] = Timestamp.now();\n                  updateData[\"pricing.depositPaymentRef\"] = paymentRef;\n                  updateData[\"pricing.balanceAmount\"] = 0;\n                  updateData[\"pricing.balancePaid\"] = true;\n                  // Confirm order\n                  if (orderData.status === \"pending\") {\n                    updateData.status = \"confirmed\";\n                  }\n                }\n\n                await updateDoc(doc(db, \"orders\", orderId), updateData);\n              }\n            } catch (updateError) {\n              console.warn(\"Order update failed (webhook may have handled it):\", updateError);\n            }\n          }\n\n          setStatus(\"success\");\n\n          // Redirect back to orders page after brief delay\n          setTimeout(() => {\n            router.push(\"/account/orders\");\n          }, 2000);\n        } else {\n          setStatus(\"failed\");\n          setError(\"Payment was not successful\");\n        }\n      } catch (err) {\n        console.error(\"Verification error:\", err);\n        setStatus(\"failed\");\n        setError(err instanceof Error ? err.message : \"Failed to verify payment\");\n      }\n    };\n\n    verifyPayment();\n  }, [paymentRef, router]);\n\n  return (\n    <div className=\"flex items-center justify-center min-h-[60vh]\">\n      <div className=\"max-w-md w-full\">\n        <div className=\"bg-[#111111] border border-[#1a1a1a] p-8 text-center\">\n          {status === \"loading\" && (\n            <>\n              <div className=\"w-16 h-16 border-4 border-[#c9a962] border-t-transparent rounded-full animate-spin mx-auto mb-6\" />\n              <h1 className=\"text-2xl font-[family-name:var(--font-cormorant)] text-[#f5f5f5] mb-2\">\n                Verifying Payment\n              </h1>\n              <p className=\"text-[#888888] font-[family-name:var(--font-montserrat)]\">\n                Please wait while we confirm your payment...\n              </p>\n            </>\n          )}\n\n          {status === \"success\" && (\n            <>\n              <div className=\"w-16 h-16 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-6\">\n                <svg className=\"w-8 h-8 text-green-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                </svg>\n              </div>\n              <h1 className=\"text-2xl font-[family-name:var(--font-cormorant)] text-[#f5f5f5] mb-2\">\n                Payment Successful!\n              </h1>\n              <p className=\"text-[#888888] font-[family-name:var(--font-montserrat)]\">\n                Redirecting you back to your orders...\n              </p>\n            </>\n          )}\n\n          {status === \"failed\" && (\n            <>\n              <div className=\"w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-6\">\n                <svg className=\"w-8 h-8 text-red-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n                </svg>\n              </div>\n              <h1 className=\"text-2xl font-[family-name:var(--font-cormorant)] text-[#f5f5f5] mb-2\">\n                Payment Verification Failed\n              </h1>\n              <p className=\"text-[#888888] font-[family-name:var(--font-montserrat)] mb-6\">\n                {error}\n              </p>\n              <Link\n                href=\"/account/orders\"\n                className=\"block w-full bg-[#c9a962] text-[#0a0a0a] py-3 text-sm tracking-[0.1em] uppercase font-[family-name:var(--font-montserrat)] hover:bg-[#d4b87a] transition-colors\"\n              >\n                Back to Orders\n              </Link>\n            </>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n\nexport default function VerifyOrderPaymentPage() {\n  return (\n    <Suspense\n      fallback={\n        <div className=\"flex items-center justify-center min-h-[60vh]\">\n          <div className=\"w-16 h-16 border-4 border-[#c9a962] border-t-transparent rounded-full animate-spin\" />\n        </div>\n      }\n    >\n      <VerifyPaymentContent />\n    </Suspense>\n  );\n}\n"],"names":[],"mappings":"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"}